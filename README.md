# Proton Precession Magnetometer
A proton precession magnetometer (PPM) is a device for measuring strength of the [Earth's magnetic field], also referred to as the geomagnetic field. Its strength at the Earth's surface ranges from 30 μT to 60 μT. The geomagnetic field changes also with time. Relatively large and rapid variations occur during magnetic storms.
### Physics
Magnetic moment placed in a magnetic field experiences a torque aligning it with the field. In the proton case magnetic moment is associated with its intrinsic angular momentum - the nuclear spin. Such association between magnetic moment and angular momentum, instead of aligning with the field, causes precession about the magnetic field direction. This phenomenon is referred to as [Larmor precession]. It turns out that frequency of Larmor precession is directly proportional to the strength of the external magnetic field. For Earth's magnetic field, the proton precession signal is in the audio range (about 2 kHz). Thus, by measuring frequency of the precession, strength of the Earth's magnetic field can be calculated.
### Hardware
Precessing proton produces an oscillating magnetic field. Observing precession of a single proton would be challenging. The way to measure frequency of the precession is to record an oscillating magnetic field generated by large enough amount of protons precessing in sync. That’s why the heart of every PPM is a container with proton rich fluid placed inside a copper coil. Frequency of the precession is determined by measuring induced AC voltage in the coil. At room temperature all protons are lined up in random directions, thus induced AC voltage equals to zero. The coil is used to line up protons in the same direction by turning on a polarizing magnetic field inside the coil by passing large current through it. After the polarization stage the same coil acts as a sensor.
AC voltage induced in the coil is just a few microvolts at best. It is too small to be effectively measured and hardware amplification is essential. The first stage is preamplifier which transforms the PPM signal from microvolt range into millivolt range. The next stage of the signal processing is bandpass filtering, which helps to reduce unwanted noise. Pass band of the filter should be adjusted to include precession frequency corresponding to value of geomagnetic field at the location of the sensor. After filtering stage, the signal is amplified and digitized. Then voltage samples are sent through a serial port to a computer for further processing. Measurement process is controlled by programmed microcontroller unit (MCU) equipped with analog to digital converter (ADC). It is worth note that the sensor, the amplifier and the MCU are galvanically separated from the computer. The computer is connected with the sensor unit using Bluetooth with Serial Port Profile. Such separation greatly reduces noise in the setup.
### Data analysis
Single PPM measurement is triggered by a start command sent through serial port from the computer. Once the start command is received by the MCU, it starts single PPM measurement. The measurement process starts with polarization stage, then is followed by data acquisition using ADC. At the end raw voltage samples are sent to the computer for further processing. First step of data processing is calculating discrete Fourier transform (DFT) in order to find peaks in the frequency domain. Usually there are many 50 Hz harmonics in the spectrum. It may be problematic when PPM peak lies very close to one of 50 Hz harmonics. Luckily PPM peak in my measurements lies between two 50 Hz harmonic peaks and is relatively high. Frequency of the PPM peak can be transformed into strength of the Earth's magnetic field. However resolution of the frequency domain calculated with DFT is limited by length of data acquisition. The longer acquisition takes, the better resolution in the frequency domain. Amplitude of induced PPM signal decays exponentially. In this project signal is sampled for 4 seconds, which corresponds to 0,25 Hz resolution in the frequency domain, which is only about 6 nT when converted into magnetic field units. Precession frequency calculated using DFT is an input for next stages of analysis. Second step is filtering out noise using Butterworth filter. Pass band of the filter is centered at the precession frequency found using Fourier analysis. The final stage is based on the assumption that, every PPM signal can be described by a sine wave with amplitude decreasing exponentially. Using nonlinear least squares method (curve_fit in Python’s scipy package) previously filtered PPM signal is fit to damped sine wave function. Output frequency allows to calculate strength of the Earth's magnetic field. Conducted experiments proved that 3 stage data analysis described in this paragraph delivers results with about 1 nT accuracy.
### First results
First measurements obtained with the setup show great correlation with data published by INTERMAGNET observatory in Belsk, as shown in the figure 1. The figure 2 shows raw and initially processed data of a single PPM measurement. The figure 3 shows the experimental setup at early stages of the project.

<figure>
    <img src="images/20160720.png" alt="Single PPM measurement" title="Single PPM measurement">
    <figcaption><i>Figure 1. Comparison of measurement results obtained using the setup and data from INTERMAGNET observatory in Belsk.</i></figcaption>
</figure>
</br>
<figure>
    <img src="images/20160720_192511_094_1_ABC.png" alt="Single PPM measurement" title="Single PPM measurement">
    <figcaption><i>Figure 2. Single PPM measurement: A) raw signal in the time domain, B) raw signal in the frequency domain, C) PPM signal after Butterworth filtering.</i></figcaption>
</figure>
</br>
<figure>
    <img src="images/ppm_setup.jpg" alt="Experimental setup" title="Experimental setup">
    <figcaption><i>Figure 3. Experimental setup at early stages of the project.</i></figcaption>
</figure>
[//]: #

   [Earth's magnetic field]: http://hyperphysics.phy-astr.gsu.edu/hbase/magnetic/MagEarth.html
   [Larmor precession]: http://hyperphysics.phy-astr.gsu.edu/hbase/Nuclear/larmor.html
